<!DOCTYPE html>
<!-- <div>Logo generated by <a href="https://www.designevo.com/" title="Free Online Logo Maker">DesignEvo free logo designer</a></div> -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width" name="viewport">
    <title>SMALLER</title>

    <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css" rel="stylesheet">
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kirang+Haerang&family=Lexend+Tera&display=swap" rel="stylesheet">

    <script src="holder.js"></script>
    <script src="bulma-toast.min.js"></script>
</head>

<style>
    html {
        font-family: 'Nunito Sans', sans-serif;
        /*background-color: #000000c9;*/
        background-color: rgb(37 37 37);

        zoom: 60%;
    }

    body {
        background-color: rgb(37 37 37);
    }

    button {
        margin: 10px;
    }

    .float-right {
        float: right;
    }

    #logo-img {
        width: 7vh;
        position: relative;
        top:20px
    }

    #main-ui {
        margin: 10px;
    }

    #about-modal-title {
        font-size: 3rem;
    }

    .tabs a:hover {
        background-color: rgba(0,0,0,1) !important;
    }

    .tabs li.is-active a {
        border-bottom-color: #32dc66;
        color: #7fff7d;
    }

    /* Ensure the size of the image fits the container perfectly */
    #image {
        max-width: 100%;  /* This rule is very important, please don't ignore this */
        display: block;
    }

    #upload-area {
        padding: 50%;
        cursor: pointer;
        /*width:100%;*/
        background-image:url(imgs/logo.png);
        background-size:     cover;                      /* <------ */
        background-repeat:   no-repeat;
        background-position: center center;              /* optional, center the image */
    }

    #main-input {
        opacity: 0;
        position: absolute;
        z-index: -1;
    }

    #app-name {
        text-align: center;
        position: relative;
        font-size: 6vh;
        /*font-family: 'Nunito Sans', sans-serif;*/
        /*font-family: 'Lexend Tera', sans-serif;*/
        font-family: 'Kirang Haerang', cursive;
    }
</style>

<body>
<div class="modal has-text-centered" id="about-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">About this application:</p>
            <button aria-label="close" class="delete" id="close-modal"></button>
        </header>
        <section class="modal-card-body has-text-white">
            <img src="imgs/logo.png"/>
            <div class='has-text-white' id="about-modal-title">Sharp</div>

            An image compressor created by David Bodey and Eric Gonzalez.
            <br/><br/>Powered by:<br/>
            Electron. NodeJS. Bulma. HTML. JS. CSS. Sharp.<br/> <br/>
        </section>
    </div>
</div>

<div class="columns hero-body">
    <div class="container has-text-centered is-12">
        <!-- UI Buttons -->
        <div class="column is-12" id="main-ui">
            <button class="button is-info is-outlined is-medium float-right">Apply Changes</button>
            <button class="button is-primary is-outlined is-medium float-right">Preview Changes</button>
            <button class="button is-warning is-5 is-outlined is-medium float-right" id="reset-button">Reset</button>
        </div>

        <!-- File Input-->
        <div class="column is-12">
            <!--label is used for background image-->
            <label class="file-label" id="upload-area" for="main-input">
                <input class="file-input" type="file" name="main-input" id="main-input">
            </label>
        </div>

        <div class="hero-foot">
            <nav class="tabs is-fullwidth">
                <div class="container">
                    <ul>
                        <li>  <div id="app-name" class=""> <img id="logo-img" src="imgs/logo.png">sm&lt;ller</img></div>
                        </li>
                        <li class="is-active"><a>Overview</a></li>
                        <li><a class="navbar-item has-text-white" id="about-modal-button">
                            About
                        </a></li>
                        <li><a class="navbar-item has-text-white">
                            Settings
                        </a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>
</div>


<script type="module">
    // Necessary variables/constants
    const image = document.getElementById('image');
    var initial_image = true;
    let test_img = 'imgs/maxresdefault.jpg';

    // Shortcut alternative to L used to toggle debugging logs
    const DEBUGGING = true;
    let L = (msg) => {
        if (DEBUGGING) console.log(msg);
    }


    // Launch modal into frame
    function showModal(modal = 'about-modal') {
        document.getElementById(modal).classList.add('is-active'); // TODO - make modular and remove hard-code
    }


    // Remove modal from frame
    function removeModal(modal = 'about-modal') {
        document.getElementById(modal).classList.remove('is-active');
    }


    // Fetch the image to rotate, and call image magick
    async function UpdateDisplay(inject_at, data) {
        let injection = document.getElementById(inject_at);

        // Updates view with processed files
        // injection.src = URL.createObjectURL(img_bytes);
        injection.src = data;

    }


    // Converts image from path to bytes
    let getBytes = async function (path) {
        const image = await fetch(path);
        const array_buffer = await image.arrayBuffer();
        const image_bytes = new Uint8Array(array_buffer);

        return image_bytes;
    }


    // Compress image from path by strength -------------------------------------------------------------------
    async function Quality() {
        const inject_at = "upload-area";
        const path = getImagePath();
        const strength = 30; // value is quality(100%) so we convert input to strength(0%)

        // const strength = Math.abs(document.getElementById("quality-button").value - 100); // value is quality(100%) so we convert input to strength(0%)
        // const img_bytes = await getBytes(path);

        const fs = require('fs');

        let old_bytes = fs.readFileSync(path)
            console.log(old_bytes);
            let new_bytes;
            new_bytes =  await reduceQuality(old_bytes, strength);

        var binaryData = [];
        binaryData.push(old_bytes);
        let data = window.URL.createObjectURL(new Blob(binaryData, {type: "application/zip"}))

        // Uses Sharp and updates view
        await UpdateDisplay(inject_at, data);
    }


    // Update onscreen UI elements
    let setStageQuality = () => {
        // Setup stage
        clearStage();
        document.getElementById('quality-list-item').classList.add('is-active');

        // Create input Bar
        const input_bar = document.createElement('input');
        input_bar.type = "text";
        input_bar.id = "quality-input";
        input_bar.placeholder = "Enter desired compression (0-100%)";
        input_bar.className = "input is-primary is-medium is-rounded";
        input_bar.name = "quality-option";
        document.getElementById('main-title').appendChild(input_bar);

        // Create quality Button
        const quality_button = document.createElement('button');
        quality_button.className = "button is-primary is-rounded is-medium is-outlined";
        quality_button.id = "quality-button";
        quality_button.innerHTML = "Adjust Image Quality";
        quality_button.name = "quality-option";
        quality_button.addEventListener('click', Quality);
        document.getElementById('main-title').appendChild(quality_button);

    }


    let clearStage = () => {
        document.getElementById('main-title').innerHTML = "";
    }


    let resetImage = () => {
        if (initial_image == true) {
            document.getElementById("main-input").src = test_img;
        } else {
            L(file_uploaded);
            document.getElementById("main-input").src = file_uploaded;
        }
        // document.getElementById("main-input").src = test_img;
        // const path = document.getElementById("main-input").src;
        // const inject_at = "main-title";
        // const img_bytes = await getBytes(path);
        // const filename = path.split('\\').pop().split('/').pop();
    }


    const fetch = require("node-fetch");
    const {v4: uuidv4} = require('uuid');

    // https://chrisfrew.in/blog/saving-images-in-node-js-using-fetch-with-array-buffer-and-buffer/
    async function savePhotoFromURL(photo_url) {
        const response = await fetch(photo_url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        return buffer;
    }

    // Returns full path of the image selected
     function getImagePath() {
        let main_input = document.getElementById('main-input');
        const filename = main_input.value.split('\\').pop().split('/').pop();
        const full_path = `${TEMP_OUT}/${filename}`;
        return full_path;
    }

    const toBase64 = file => new Promise((resolve, reject) => { // (https://stackoverflow.com/questions/36280818/how-to-convert-file-to-base64-in-javascript)
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });


    // Location used to output files to desktop regardless of Operating System
    const homeDir = require('os').homedir();
    const desktopDir = `${homeDir}/Desktop`;
    const TEMP_OUT = desktopDir;

    async function reduceQuality(obj, strength) {
        L('(Reducing Quality and Size...)');

        const Sharp = require('../node_modules/sharp');
        const fs = require('fs');
        const random_uuid = uuidv4();
        let quality = Math.abs(strength - 100);
        let format = "webp";
        // let photo_url = "https://picsum.photos/200/300"
        // let obj = await savePhotoFromURL(photo_url);
        // let obj = old_bytes
        let out_file = await Sharp(obj)
            .toFormat(format, {
                quality: parseInt(quality)
            })
            .toBuffer()
            .then(async data => {
                fs.writeFileSync(`${desktopDir}/${random_uuid}.${format}`, data);
                // document.getElementById("main-input").src = `${desktopDir}/${random_uuid}.${format}`;
                L(data)
                L(upload_area)
                upload_area.style.backgroundImage = `url(${await URL.createObjectURL(
                    new Blob([data.buffer])
                )})`
            })
            .catch(err => {
                L(err)
            });
        L(out_file);
    }

    // EVENT LISTENERS AT START
    // document.getElementById('quality-list-item').addEventListener('click', setStageQuality);
    document.getElementById('about-modal-button').addEventListener('click', showModal);
    document.getElementById('close-modal').addEventListener('click', removeModal);
    document.getElementById('reset-button').addEventListener('click', resetImage);

    //Sharp test code
    let upload_area = document.getElementById('upload-area');
    let file_uploaded;

    document.getElementById('main-input').addEventListener('change', Quality);

</script>
</body>

</html>
