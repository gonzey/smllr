<!DOCTYPE html>
<!-- <div>Logo generated by <a href="https://www.designevo.com/" title="Free Online Logo Maker">DesignEvo free logo designer</a></div> -->
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width" name="viewport">
    <title>Image Genie</title>

    <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css" rel="stylesheet">
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200&display=swap" rel="stylesheet">
    <link href="cropper.css" rel="stylesheet">
    <link href="dropzone.css" rel="stylesheet">

    <script src="cropper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.js"></script>
    <script src="holder.js"></script>
    <script src="bulma-toast.min.js"></script>
</head>

<style>
    .dropzone.scroll {
        /* width: 50%; */
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        text-align: center;
        padding: 20px;
    }

    html {
        font-family: 'Nunito Sans', sans-serif;
        background-color: #000000c9;
        zoom: 60%;
    }

    body {
        background-color: rgb(37 37 37);
    }

    button {
        margin: 10px;
    }

    .delete {
        color: red;
    }

    .float-right {
        float: right;
    }

    .dropzone .dz-preview .dz-image {
        width: 300px !important;
        height: 300px !important;

    }

    .header {
        background-color: rgba(0, 0, 0, 0.15);
    }

    #logo-img {
        width: 100px;
    }

    #main-ui {
        margin: 10px;
    }

    #main-drop {
        /*border: solid white 20px;*/
        /*border-bottom: solid white 140px;*/
        background-color: #1514143d;
        position: relative;
        left: -20px;
    }

    .modal {
        font-family: 'Nunito Sans', sans-serif;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .delete {
        background-color: red;
    }

    .modal-card-body {
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-background {
        background-color: rgba(0, 0, 0, 0.5);
    }

    #about-modal-title {
        font-size: 3rem;
    }

    .tabs a {
        color: lightskyblue
    }

    .tabs a:hover {
        color: white
    }

    .tabs li.is-active a {
        border-bottom-color: #32dc66;
        color: #7fff7d;
    }

    /* Ensure the size of the image fits the container perfectly */
    #image {
        max-width: 100%;  /* This rule is very important, please don't ignore this */
        display: block;
    }
</style>

<body>
<div class="modal has-text-centered" id="about-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">About this application:</p>
            <button aria-label="close" class="delete" id="close-modal"></button>
        </header>
        <section class="modal-card-body has-text-white">
            <img src="imgs/logo.png"/>
            <div class='has-text-white' id="about-modal-title">Image Genie</div>

            An image editor and manipulator created by David Bodey and Eric Gonzalez.
            <br/><br/>Powered by:<br/>
            Electron. NodeJS. Bulma. HTML. JS. CSS. Imagemagick. DropzoneJS.<br/> <br/>

            Special Thanks: <br/>
            https://github.com/KnicKnic/WASM-ImageMagick<br/><br/>

        </section>
    </div>
</div>

<!-- Main Header -->
<nav class="navbar header">
    <img class="" id="logo-img" src="imgs/logo.png"/>

    <!-- Logo -->
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item">
            </a>
        </div>

        <!-- Items -->
        <div class="navbar-menu">
            <div class="navbar-end">
                <a class="navbar-item has-text-white" id="about-modal-button">
                    About
                </a>
                <a class="navbar-item has-text-white">
                    Settings
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- ACTIONS -->
<nav class="tabs is-fullwidth has-text-white">
    <div class="column is-1">
        <ul>
            <li id="overview-list-item">
                <a>Overview</a>
            </li>
            <li id="scale-list-item">
                <a>Scale</a>
            </li>
            <li id="color-list-item">
                <a>Color</a>
            </li>
            <li id="quality-list-item">
                <a>Quality</a>
            </li>
            <li id="crop-list-item">
                <a>Crop</a>
            </li>
            <li id="rotate-list-item">
                <a>Rotate</a>
            </li>
        </ul>
    </div>
    <div class="column is-5" id="main-ui">
        <button class="button is-info is-outlined is-medium float-right">Apply Changes</button>
        <button class="button is-primary is-outlined is-medium float-right">Preview Changes</button>
        <button class="button is-warning is-5 is-outlined is-medium float-right" id="reset-button">Reset</button>
    </div>
</nav>

<div class="columns">
    <div class="container has-text-centered">
        <!-- PHOTOS -->
        <div class="column" id="main-view">
            <br/><img id="main-img"><br/>
        </div>

        <!-- UI CONTROLS -->
        <div class="column is-2" id=""></div>
        <div class="column is-8" id="main-title"></div>
        <div class="column is-2" id=""></div>
    </div>

    <!-- QUEUED PHOTOS -->
    <form action="/photo" class="dropzone scroll column is-2" id="main-drop">
        <div class="dz-message" data-dz-message>
          <span>
            <svg style="width: 75px; height: 75px; color:white;" viewBox="0 0 24 24">
              <path d="M7,15L11.5,9L15,13.5L17.5,10.5L21,15M22,4H14L12,2H6A2,2 0 0,0 4,4V16A2,2 0 0,0 6,18H22A2,2 0 0,0 24,16V6A2,2 0 0,0 22,4M2,6H0V11H0V20A2,2 0 0,0 2,22H20V20H2V6Z"
                    fill="currentColor"/>
            </svg>
          </span>
        </div>
    </form>

    <!-- smllr test -->
    <button id="sharp-test-button">Click to run Sharp test</button>

</div>

<script type="module">
    // REQUIRED CONSTANTS AND IMPORTS
    const {ipcRenderer} = require('electron');
    var path = require("path");
    const IS_OFFLINE = true;
    let runRotate, runScale;

    // OFFLINE FUNCTIONS
    if (IS_OFFLINE) {
        runRotate = () => {
            let image = document.getElementById('main-img');
            const image_path = image.src;
            L("[Running offline Rotate]");
            var degrees = document.getElementById('rotate-input').value;

            ipcRenderer.invoke('runRotate', [image_path, degrees]).then((result) => {
                L(`result: ${result}`)
                image.src = result;
            })
            image.offsetHeight;

        }
        runScale = () => {
            L("[Running offline Scale]");
        }
    }

    // Imports
    import * as Magick from './wasm-imagemagick/dist/magickApi.js';

    // Necessary variables/constants
    const image = document.getElementById('image');
    var initial_image = true;
    let test_img = 'imgs/maxresdefault.jpg';

    // Shortcut alternative to L used to toggle debugging logs
    const DEBUGGING = true;
    let L = (msg) => {
        if (DEBUGGING) L(msg);
    }


    // Launch modal into frame
    function showModal(modal = 'about-modal') {
        document.getElementById(modal).classList.add('is-active'); // TODO - make modular and remove hard-code
    }


    // Remove modal from frame
    function removeModal(modal = 'about-modal') {
        document.getElementById(modal).classList.remove('is-active');
    }


    // Fetch the image to rotate, and call image magick
    async function UpdateDisplay(inject_at, files, command) {
        let injection = document.getElementById(inject_at);
        const results = await Magick.Call(files, command);
        const image = results[0];

        // Updates view with processed files
        injection.src = URL.createObjectURL(image['blob']);
    }


    // Fetch the image for which to retrieve EXIF data, and call image magick
    async function UpdateOverviewDisplay(inject_at, name, path) {
        let injection = document.getElementById(inject_at);
        // const { stdout, stderr, exitCode } = await Magick.execute({
        //   inputFiles: [await Magick.buildInputFile(`imgs/${name}`)],
        //   commands: `identify ${name}`
        // });
        const stdout = await Magick.extractInfo(await Magick.buildInputFile(`imgs/${name}`))
        const img_json = stdout[0]['image'];
        const filesize = img_json['filesize'];
        document.getElementById('overview-display').innerHTML += filesize;
        L(stdout)
    }


    // Converts image from path to bytes
    let getBytes = async function (path) {
        const image = await fetch(path);
        const array_buffer = await image.arrayBuffer();
        const image_bytes = new Uint8Array(array_buffer);

        return image_bytes;
    }

    async function Overview() {
        const path = document.getElementById("main-img").src;
        const inject_at = "main-title";
        const img_bytes = await getBytes(path);
        const filename = path.split('\\').pop().split('/').pop();
        // const files = [{
        //   'name': filename,
        //   'content': img_bytes
        // }];
        // const command = [
        //   "identify",filename
        // ];

        L('Attempting to display EXIF data')

        await UpdateOverviewDisplay(inject_at, filename, path);
    }

    let setStageOverview = () => {
        // document.getElementById('main-title').querySelectorAll('*').forEach(child => child.remove());
        clearStage();

        document.getElementById('overview-list-item').classList.add('is-active');

        var exif_display = document.createElement('div');
        exif_display.id = "overview-display";
        exif_display.placeholder = "EXIF data here";
        exif_display.className = "textarea";
        exif_display.name = "overview-option";
        document.getElementById('main-title').appendChild(exif_display);

        Overview();
    }

    async function Scale() {
        const width_val = document.getElementById('scale-width').value;
        const height_val = document.getElementById('scale-height').value;

        const path = document.getElementById("main-img").src;
        const inject_at = "main-img";
        const scale_vals = width_val + "x" + height_val;
        const img_bytes = await getBytes(path);
        const filename = path.split('\\').pop().split('/').pop();
        const files = [{
            'name': filename,
            'content': img_bytes
        }];

        const command = [
            "convert",
            filename,
            "-scale",
            scale_vals,
            "out.png"
        ];

        L('[Attempting to scale]');

        // Uses Imagemagick and updates view
        if (scale_vals) await UpdateDisplay(inject_at, files, command);
    }


    let setStageScale = () => {
        // Setup stage
        clearStage();
        document.getElementById('scale-list-item').classList.add('is-active');

        // Create inputs for width and height
        var input_bar_width = document.createElement('input');
        input_bar_width.type = "text";
        input_bar_width.id = "scale-width";
        input_bar_width.placeholder = "Enter width";
        input_bar_width.className = "input is-primary is-medium is-rounded";
        input_bar_width.name = "scale-option";
        document.getElementById('main-title').appendChild(input_bar_width);

        var input_bar_height = document.createElement('input');
        input_bar_height.type = "text";
        input_bar_height.id = "scale-height";
        input_bar_height.placeholder = "Enter height";
        input_bar_height.className = "input is-primary is-medium is-rounded";
        input_bar_height.name = "scale-option";
        document.getElementById('main-title').appendChild(input_bar_height);

        // Create scale Button
        var scale_button = document.createElement('button');
        scale_button.className = "button is-primary is-rounded is-medium is-outlined";
        scale_button.id = "scale-button";
        scale_button.innerHTML = "Scale the Image";
        scale_button.name = "scale-option";
        scale_button.addEventListener('click', Scale);
        document.getElementById('main-title').appendChild(scale_button);
    }


    async function Color() { // Necessary for Imagemagick call
        const red_val = document.getElementById('color-input-red').value;
        const green_val = document.getElementById('color-input-green').value;
        const blue_val = document.getElementById('color-input-blue').value;

        const path = document.getElementById("main-img").src;
        const inject_at = "main-img";
        const rgb_vals = red_val + "," + green_val + "," + blue_val;
        const img_bytes = await getBytes(path);
        const filename = path.split('\\').pop().split('/').pop();
        const files = [{
            'name': filename,
            'content': img_bytes
        }];

        const command = [
            "convert",
            filename,
            "-colorize",
            rgb_vals,
            "out.png"
        ];

        L('[Attempting to color]');

        // Uses Imagemagick and updates view
        if (rgb_vals) await UpdateDisplay(inject_at, files, command);
    }

    let setStageColor = () => {
        // Setup stage
        clearStage();
        document.getElementById('color-list-item').classList.add('is-active');

        // Create input Bar
        var input_bar_red = document.createElement('input');
        input_bar_red.type = "text";
        input_bar_red.id = "color-input-red";
        input_bar_red.placeholder = "Enter red value";
        input_bar_red.className = "input is-primary is-medium is-rounded";
        input_bar_red.name = "color-option-red";
        document.getElementById('main-title').appendChild(input_bar_red);

        var input_bar_green = document.createElement('input');
        input_bar_green.type = "text";
        input_bar_green.id = "color-input-green";
        input_bar_green.placeholder = "Enter green value";
        input_bar_green.className = "input is-primary is-medium is-rounded";
        input_bar_green.name = "color-option-green";
        document.getElementById('main-title').appendChild(input_bar_green);

        var input_bar_blue = document.createElement('input');
        input_bar_blue.type = "text";
        input_bar_blue.id = "color-input-blue";
        input_bar_blue.placeholder = "Enter blue value";
        input_bar_blue.className = "input is-primary is-medium is-rounded";
        input_bar_blue.name = "color-option-blue";
        document.getElementById('main-title').appendChild(input_bar_blue);

        // Create color Button
        const color_button = document.createElement('button');
        color_button.className = "button is-primary is-rounded is-medium is-outlined";
        color_button.id = "color-button";
        color_button.innerHTML = "Colorize the Image";
        color_button.name = "color-option";
        color_button.addEventListener('click', Color);
        document.getElementById('main-title').appendChild(color_button);
    }


    // Compress image from path by strength -------------------------------------------------------------------
    async function Quality() { // Necessary for Imagemagick call
        const path = document.getElementById("main-img").src;
        const inject_at = "main-img";
        const strength = document.getElementById("quality-button").value;
        const img_bytes = await getBytes(path);
        const filename = path.split('\\').pop().split('/').pop();
        const files = [{
            'name': filename,
            'content': img_bytes
        }];
        const command = [
            "convert",
            filename,
            "-quality",
            strength,
            "out.png"
        ];

        // Uses Imagemagick and updates view
        await UpdateDisplay(inject_at, files, command);
    }


    let setStageQuality = () => {
        // Setup stage
        clearStage();
        document.getElementById('quality-list-item').classList.add('is-active');

        // Create input Bar
        const input_bar = document.createElement('input');
        input_bar.type = "text";
        input_bar.id = "quality-input";
        input_bar.placeholder = "Enter desired quality (0-100%)";
        input_bar.className = "input is-primary is-medium is-rounded";
        input_bar.name = "quality-option";
        document.getElementById('main-title').appendChild(input_bar);

        // Create quality Button
        const quality_button = document.createElement('button');
        quality_button.className = "button is-primary is-rounded is-medium is-outlined";
        quality_button.id = "quality-button";
        quality_button.innerHTML = "Adjust Image Quality";
        quality_button.name = "quality-option";
        quality_button.addEventListener('click', Quality);
        document.getElementById('main-title').appendChild(quality_button);

    }
    

    // Rotates image from path by degrees -------------------------------------------------------------------
    async function Rotate() { // Necessary for Imagemagick call
        const path = document.getElementById("main-img").src;
        const inject_at = "main-img";
        const degrees = document.getElementById('rotate-input').value;
        const img_bytes = await getBytes(path);
        const filename = path.split('\\').pop().split('/').pop();
        const files = [{
            'name': filename,
            'content': img_bytes
        }];
        const command = [
            "convert",
            filename,
            "-rotate",
            degrees,
            "out.png"
        ];

        L('[Attempting rotate]');

        // Uses Imagemagick and updates view
        if (degrees) UpdateDisplay(inject_at, files, command);
    }


    let setStageRotate = () => {
        // Setup stage
        clearStage();
        document.getElementById('rotate-list-item').classList.add('is-active');

        // Create input Bar
        const input_bar = document.createElement('input');
        input_bar.type = "text";
        input_bar.id = "rotate-input";
        input_bar.placeholder = "Enter degrees to rotate NOW!!!!!!!please";
        input_bar.className = "input is-primary is-medium is-rounded";
        input_bar.name = "rotate-option";
        document.getElementById('main-title').appendChild(input_bar);

        // Create rotate Button
        const rotate_button = document.createElement('button');
        rotate_button.className = "button is-primary is-rounded is-medium is-outlined";
        rotate_button.id = "rotate-button";
        rotate_button.innerHTML = "Rotate the Image";
        rotate_button.name = "rotate-option";
        rotate_button.addEventListener('click', runRotate); //modified from local Rotate to backend runRotate
        document.getElementById('main-title').appendChild(rotate_button);
    }

    let clearStage = () => {
        document.getElementById('main-title').innerHTML = "";
    }

    let resetImage = () => {
        if (initial_image == true) {
            document.getElementById("main-img").src = test_img;
        } else {
            L(file_uploaded);
            document.getElementById("main-img").src = file_uploaded;
        }
        // document.getElementById("main-img").src = test_img;
        // const path = document.getElementById("main-img").src;
        // const inject_at = "main-title";
        // const img_bytes = await getBytes(path);
        // const filename = path.split('\\').pop().split('/').pop();
    }

    const fetch = require("node-fetch");
    const {v4: uuidv4} = require('uuid');

    // https://chrisfrew.in/blog/saving-images-in-node-js-using-fetch-with-array-buffer-and-buffer/
    async function savePhotoFromURL(photo_url) {
        const response = await fetch(photo_url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        return buffer;
    }

    const homeDir = require('os').homedir();
    const desktopDir = `${homeDir}/Desktop`;

    async function runSharpTest() {
        L('(running sharp)');
        const Sharp = require('../node_modules/sharp');
        const fs = require('fs');
        const random_uuid = uuidv4();

        let width = 6000;
        let height = 4000;
        let crop = "cover";
        let quality = 60;
        let format = "webp";
        let photo_url = "https://picsum.photos/200/300"
        let obj = await savePhotoFromURL(photo_url);
        let out_file = Sharp(obj)
            .toFormat(format, {
                quality: parseInt(quality)
            })
            .toBuffer()
            .then(data => {
                fs.writeFileSync(`${desktopDir}/${random_uuid}.${format}`, data);
                document.getElementById("main-img").src = `${desktopDir}/${random_uuid}.${format}`;
            })
            .catch(err => {
                L(err)
            });
        L(out_file);
    }


    // EVENT LISTENERS AT START
    document.getElementById('color-list-item').addEventListener('click', setStageColor);
    document.getElementById('quality-list-item').addEventListener('click', setStageQuality);
    document.getElementById('overview-list-item').addEventListener('click', setStageOverview);
    document.getElementById('rotate-list-item').addEventListener('click', setStageRotate);
    document.getElementById('scale-list-item').addEventListener('click', setStageScale);
    document.getElementById('about-modal-button').addEventListener('click', showModal);
    document.getElementById('close-modal').addEventListener('click', removeModal);
    document.getElementById('reset-button').addEventListener('click', resetImage);

    //Sharp test code
    const sharp_test_button = document.getElementById('sharp-test-button');
    let file_uploaded;

    sharp_test_button.addEventListener('click', runSharpTest);

    //Dropzone initialization
    Dropzone.options.mainDrop = { // use camelcase from dropzone to find instead of hyphen
        init: function () {
            this.on("addedfile", function (file) {
                initial_image = false;
                document.getElementById("main-img").src = file.path;
                file_uploaded = file.path;
            });
            // this.on("addedfile", function(file) { alert(document.getElementById("main-img").src + " VS " + file.path); });
        },
        thumbnailWidth: 300,
        thumbnailHeight: 300
    }

    // RUN
    // let test_img = 'imgs/maxresdefault.jpg';
    document.getElementById("main-img").src = test_img;
</script>
</body>

</html>
