<!DOCTYPE html>
<!-- <div>Logo generated by <a href="https://www.designevo.com/" title="Free Online Logo Maker">DesignEvo free logo designer</a></div> -->
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width" name="viewport">
    <title>SMALLER</title>

    <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/12925c0993.js" crossorigin="anonymous"></script>

    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kirang+Haerang&family=Lexend+Tera&display=swap" rel="stylesheet">

    <script src="holder.js"></script>
    <script src="bulma-toast.min.js"></script>
</head>

<style>
    html {
        font-family: 'Nunito Sans', sans-serif;
        background-color: rgb(37 37 37);
        /*zoom: 50%;*/
        /*background-color: #000000c9;*/
    }

    body {
        background-color: rgb(37 37 37);
    }

    button {
        margin: 10px;
    }

    .float-right {
        float: right;
    }

    #logo-img {
        width: 3vh;
        position: relative;
        top:10px
    }

    #top-buttons {
        margin: 10px;
    }

    #about-modal-title {
        font-size: 3rem;
    }

    .tabs a:hover {
        background-color: rgba(0,0,0,0) !important;
    }

    .tabs li.is-active a {
        border-bottom-color: #32dc66;
        color: #7fff7d;
    }

    /* Ensure the size of the image fits the container perfectly */
    #image {
        max-width: 100%;  /* This rule is very important, please don't ignore this */
        display: block;
    }

    #upload-area {
        padding: 50%;
        cursor: pointer;
        /*width:100%;*/
        background-image: url(imgs/logo.png);
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center center;
    }

    #main-input {
        opacity: 0;
        position: absolute;
        z-index: -1;
    }

    #app-name {
        text-align: center;
        position: relative;
        font-size: 2vh;
        /*font-family: 'Nunito Sans', sans-serif;*/
        font-family: 'Lexend Tera', sans-serif;
        /*font-family: 'Kirang Haerang', cursive;*/
    }

    .card {
        margin: 10px;
        color: white;
        background-color: #252525;
    }

    .title {
        color: white;
    }
</style>

<body>
<div class="modal has-text-centered" id="about-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">About this application:</p>
            <button aria-label="close" class="delete" id="close-modal"></button>
        </header>
        <section class="modal-card-body has-text-white">
            <img src="imgs/logo.png"/>
            <div class='has-text-white' id="about-modal-title">SMALLER</div>

            An image compressor created by David Bodey and Eric Gonzalez.
            <br/><br/>Powered by:<br/>
            Electron. NodeJS. Bulma. HTML. JS. CSS. Sharp.<br/> <br/>
        </section>
    </div>
</div>

<div class="container has-text-centered is-12">
    <!-- UI Buttons -->
    <div class="column is-12" id="top-buttons">
        <button class="button is-info is-outlined is-medium float-right">Export</button>
        <!--            <button class="button is-primary is-outlined is-medium float-right">Preview Changes</button>-->
        <button class="button is-warning is-5 is-outlined is-medium float-right" id="reset-button">Reset</button>

    </div>
    <!-- File Input-->
<!--    <div class="column is-12">-->
        <!--label is used for background image-->
        <!--            <label class="file-label" id="upload-area" for="main-input">-->
        <!--                <input class="file-input" type="file" name="main-input" id="main-input">-->
        <!--            </label>-->
<!--    </div>-->
    <div class="hero-foot">
        <nav class="tabs is-fullwidth">
            <div class="container">
                <ul>
                    <li>  <div id="app-name"> <img id="logo-img" src="imgs/logo.png">smaller</img></div>
                    </li>
                    <li class="is-active"><a>Overview</a></li>
                    <li><a class="navbar-item has-text-white" id="about-modal-button">
                        About
                    </a></li>
                    <li><a class="navbar-item has-text-white">
                        Settings
                    </a></li>
                </ul>
            </div>
        </nav>
    </div>
<br>
    <div class="columns is-link" id="main-inputs">

        <!-- Quality picker -->
        <div class=" control has-icons-left">
            <input class="input" type="text" placeholder="Quality[0-100]" required>
            <span class="icon is-medium is-left">
                <i class="far fa-eye"></i>
            </span>
        </div>

        <!-- Export Format dropdown-->
        <div class="select">
            <select>
                <option>JPEG</option>
                <option>PNG</option>
                <option>WEBP</option>
                <option>GIF</option>
                <option>TIFF</option>
                <option>AVIF</option>
                <option>HEIF</option>
            </select>
        </div>
    </div>

<!-- Before/After Image cards -->
<section class="hero">

<div class="columns hero-body" id="main-imgs">
    <div class="card">
        <div class="card-image">
            <img class="column is-12" id="before-image" src="imgs/logo-full.svg" />
        </div>
        <div class="card-content">
            <div class="media">
                <div class="media-content">
                    <p class="title is-4">Before</p>
                    <p class="subtitle is-6">ImageName.jpg</p>
                </div>
            </div>

            <div class="content">
                xx MB
                <br>
                <time datetime="2016-1-1">11:09 PM - 1 Jan 2016</time>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-image">
            <img class="column is-12" id="after-image" src="imgs/drag-instructions.png" />
        </div>
        <div class="card-content">
            <div class="media">
                <div class="media-content">
                    <p class="title is-4">After</p>
                    <p class="subtitle is-6">ImageName.png</p>
                </div>
            </div>

            <div class="content">
                xx MB
                <br>
                <time datetime="2021-07-25">02:54 PM - 25 Jul 2021</time>
            </div>
        </div>
    </div>
</div>
</section>

</div>

<script type="module">
    // https://www.geeksforgeeks.org/drag-and-drop-files-in-electronjs/
    document.addEventListener('drop', (event) => {
        event.preventDefault();
        event.stopPropagation();
        for (const f of event.dataTransfer.files) {
            // Using the path attribute to get absolute file path and update main image
            L('File Path of dragged files: ', f.path)
            L(f.path)
            document.getElementById('before-image').src = "file://" + f.path;
            document.getElementById('after-image').src = "file://" + f.path;
        }
    });

    document.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    document.addEventListener('dragenter', (event) => {
        console.log('File is in the Drop Space');
    });

    document.addEventListener('dragleave', (event) => {
        console.log('File has left the Drop Space');
    });

    // Necessary variables/constants
    const image = document.getElementById('image');
    var initial_image = true;
    let test_img = 'imgs/maxresdefault.jpg';

    // Shortcut alternative to L used to toggle debugging logs
    const DEBUGGING = true;
    let L = (msg) => {
        if (DEBUGGING) console.log(msg);
    }


    // Launch modal into frame
    function showModal(modal = 'about-modal') {
        document.getElementById(modal).classList.add('is-active'); // TODO - make modular and remove hard-code
    }


    // Remove modal from frame
    function removeModal(modal = 'about-modal') {
        document.getElementById(modal).classList.remove('is-active');
    }


    // Fetch the image to rotate, and call image magick
    async function UpdateDisplay(inject_at, data) {
        let injection = document.getElementById(inject_at);

        // Updates view with processed files
        // injection.src = URL.createObjectURL(img_bytes);
        injection.src = data;
    }


    // Converts image from path to bytes
    let getBytes = async function (path) {
        const image = await fetch(path);
        const array_buffer = await image.arrayBuffer();
        const image_bytes = new Uint8Array(array_buffer);

        return image_bytes;
    }


    // Compress image from path by strength -------------------------------------------------------------------
    async function Quality() {
        const inject_at = "upload-area";
        const path = getImagePath();
        const strength = 30; // value is quality(100%) so we convert input to strength(0%)

        // const strength = Math.abs(document.getElementById("quality-button").value - 100); // value is quality(100%) so we convert input to strength(0%)
        // const img_bytes = await getBytes(path);

        const fs = require('fs');

        let old_bytes = fs.readFileSync(path)
            console.log(old_bytes);
            let new_bytes;
            new_bytes =  await reduceQuality(old_bytes, strength);

        var binaryData = [];
        binaryData.push(old_bytes);
        let data = window.URL.createObjectURL(new Blob(binaryData, {type: "application/zip"}))

        // Uses Sharp and updates view
        await UpdateDisplay(inject_at, data);
    }


    // Update onscreen UI elements
    let setStageQuality = () => {
        // Setup stage
        clearStage();
        document.getElementById('quality-list-item').classList.add('is-active');

        // Create input Bar
        const input_bar = document.createElement('input');
        input_bar.type = "text";
        input_bar.id = "quality-input";
        input_bar.placeholder = "Enter desired compression (0-100%)";
        input_bar.className = "input is-primary is-medium is-rounded";
        input_bar.name = "quality-option";
        document.getElementById('main-title').appendChild(input_bar);

        // Create quality Button
        const quality_button = document.createElement('button');
        quality_button.className = "button is-primary is-rounded is-medium is-outlined";
        quality_button.id = "quality-button";
        quality_button.innerHTML = "Adjust Image Quality";
        quality_button.name = "quality-option";
        quality_button.addEventListener('click', Quality);
        document.getElementById('main-title').appendChild(quality_button);

    }


    let clearStage = () => {
        document.getElementById('main-title').innerHTML = "";
    }


    let resetImage = () => {
        if (initial_image == true) {
            document.getElementById("main-input").src = test_img;
        } else {
            L(file_uploaded);
            document.getElementById("main-input").src = file_uploaded;
        }
        // document.getElementById("main-input").src = test_img;
        // const path = document.getElementById("main-input").src;
        // const inject_at = "main-title";
        // const img_bytes = await getBytes(path);
        // const filename = path.split('\\').pop().split('/').pop();
    }


    const fetch = require("node-fetch");
    const {v4: uuidv4} = require('uuid');

    // https://chrisfrew.in/blog/saving-images-in-node-js-using-fetch-with-array-buffer-and-buffer/
    async function savePhotoFromURL(photo_url) {
        const response = await fetch(photo_url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        return buffer;
    }

    // Returns full path of the image selected
     function getImagePath() {
        let main_input = document.getElementById('main-input');
        const filename = main_input.value.split('\\').pop().split('/').pop();
        const full_path = `${TEMP_OUT}/${filename}`;
        return full_path;
    }

    const toBase64 = file => new Promise((resolve, reject) => { // (https://stackoverflow.com/questions/36280818/how-to-convert-file-to-base64-in-javascript)
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });


    // Location used to output files to desktop regardless of Operating System
    const homeDir = require('os').homedir();
    const desktopDir = `${homeDir}/Desktop`;
    const TEMP_OUT = desktopDir;

    async function reduceQuality(obj, strength) {
        L('(Reducing Quality and Size...)');

        const Sharp = require('../node_modules/sharp');
        const fs = require('fs');
        const random_uuid = uuidv4();
        let quality = Math.abs(strength - 100);
        let format = "webp";
        // let photo_url = "https://picsum.photos/200/300"
        // let obj = await savePhotoFromURL(photo_url);
        // let obj = old_bytes

        // https://sharp.pixelplumbing.com/api-output#toformat
        let out_file = await Sharp(obj)
            .toFormat(format, {
                quality: parseInt(quality)
            })
            .toBuffer()
            .then(async data => {
                fs.writeFileSync(`${desktopDir}/${random_uuid}.${format}`, data);
                // document.getElementById("main-input").src = `${desktopDir}/${random_uuid}.${format}`;
                L(data)
                L(upload_area)
                upload_area.style.backgroundImage = `url(${await URL.createObjectURL(
                    new Blob([data.buffer])
                )})`
            })
            .catch(err => {
                L(err)
            });
        L(out_file);
    }

    // EVENT LISTENERS AT START
    // document.getElementById('quality-list-item').addEventListener('click', setStageQuality);
    document.getElementById('about-modal-button').addEventListener('click', showModal);
    document.getElementById('close-modal').addEventListener('click', removeModal);
    document.getElementById('reset-button').addEventListener('click', resetImage);

    //Sharp test code
    let upload_area = document.getElementById('upload-area');
    let file_uploaded;

    document.getElementById('main-input').addEventListener('change', Quality);

</script>
</body>

</html>
