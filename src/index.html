<!DOCTYPE html>
<!-- <div>Logo generated by <a href="https://www.designevo.com/" title="Free Online Logo Maker">DesignEvo free logo designer</a></div> -->
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width" name="viewport">
    <title>The Compression App</title>
    <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/12925c0993.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="remus.css">
    <script src="remus.js"></script>
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kirang+Haerang&family=Lexend+Tera&display=swap" rel="stylesheet">
    <script src="holder.js"></script>
    <script src="bulma-toast.min.js"></script>
</head>

<style>
    html {
        font-family: 'Nunito Sans', sans-serif;
        zoom: 80%;
        background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(19,0,25,1) 100%);
    }

    .float-right {
        float:right !important;
    }

    body {
        background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(19,0,25,1) 100%)
    }

    button {
        margin: 10px;
    }

    #logo-img {
        width: 3vh;
        position: relative;
        top:0px
    }

    #app-name {
        text-align: center;
        position: relative;
        font-size: 3vh;
        font-family: 'Nunito Sans', sans-serif;
    }

    #top-buttons {
        margin: 10px;
    }

    #about-modal-title {
        font-size: 3rem;
        font-family: 'Nunito Sans', sans-serif;
    }

    .tabs a:hover {
        background-color: rgba(0,0,0,0) !important;
    }

    .tabs li.is-active a {
        border-bottom-color: #32dc66;
        color: #7fff7d;
    }

    input.vertical {
        -webkit-appearance: slider-vertical;
        writing-mode: bt-lr;
    }

    #about-modal {
        z-index: 999;
    }

    p {
        color: white;
    }
</style>

<body>
<div class="modal has-text-centered" id="about-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">About this application</p>
            <button aria-label="close" class="delete" id="close-modal"></button>
        </header>
        <section class="modal-card-body has-text-white has-background-black">
            <img src="imgs/logo.png"/>
            <div class='has-text-white app-name' id="about-modal-title">smaller</div>

            An image compressor created by David Bodey and Eric Gonzalez.
            <br/><br/>Powered by:<br/>
            Electron. NodeJS. Bulma. HTML. JS. CSS. Sharp. Remus.<br/> <br/>
        </section>
    </div>
</div>

<div class="container has-text-centered is-12">
    <!-- UI Buttons -->
    <div class="column is-12" id="top-buttons">
        <button class="button is-info is-outlined is-medium float-right" id="export-button">Export</button>
   </div>

    <div class="hero-foot">
        <nav class="tabs is-fullwidth">
            <div class="container">
                <ul>
                    <li>
                        <div id="app-name"> <img id="logo-img" src="imgs/logo.png">smaller</div>
                    </li>
                    <li class="is-active">
                        <a>Overview</a>
                    </li>
                    <li>
                        <a class="navbar-item has-text-white" id="about-modal-button">About</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <br>

    <!-- User input buttons and sliders -->
    <div class="columns is-link" id="main-inputs">
        <div class=" column is-2">
            <div class="is-black has-text-primary-light is-size-4">Options</div>
            <div class="card-content">
                <!-- Export Format dropdown-->
                <div class="select">
                    <select id="format-dropdown">
                        <option value="none" selected disabled hidden>Format</option>
                        <option value="JPEG">JPEG</option>
                        <option value="PNG">PNG</option>
                        <option value="WEBP">WEBP</option>
                    </select>
                </div>
                <br><br><hr>

                <!-- Quality Range slider -->
                <label class="has-text-primary-light is-size-4" for="quality-slider">Quality</label><br><br>
                <input id="quality-slider" type="range" min="1" max="100" value="50" list="slider-steps">
                <datalist id="slider-steps">
                    <option>1</option>
                    <option>5</option>
                    <option>10</option>
                    <option>15</option>
                    <option>20</option>
                    <option>25</option>
                    <option>30</option>
                    <option>35</option>
                    <option>40</option>
                    <option>45</option>
                    <option>50</option>
                    <option>55</option>
                    <option>60</option>
                    <option>65</option>
                    <option>70</option>
                    <option>75</option>
                    <option>80</option>
                    <option>85</option>
                    <option>90</option>
                    <option>95</option>
                    <option>100</option>
                </datalist>
            </div>
        </div>

        <!-- Before/After Image cards -->
        <section class="hero column is-10">
            <div class="remus" id="main-imgs">
                <!-- Before -->
                <div class="card remus-element">
                    <a href="imgs/logo-full.svg" class="card-image" id="before-image-card" target="_blank">
                        <img id="before-image" src="imgs/logo-full.svg" />
                    </a>
                </div>
                <!-- After -->
                <div class="card remus-element">
                    <a href="imgs/drag-instructions.png" class="card-image" id="after-image-card" target="_blank">
                        <img class="" id="after-image" src="imgs/drag-instructions.png" />
                    </a>
                </div>
            </div>
        </section>
        <!-- Before Image Format -->
        <p id="before-image-format">Before Image Format: N/A</p>

        <!-- After Image Format -->
        <p id="after-image-format">After Image Format: N/A</p>
    </div>
</div>

<script type="module">
    // Before/After slider
    var remus = new Remus({
        element: '.remus', // selector for main Remus container
        height: null // height value in pixels if you want it to be fixed - optional
    });

    // https://www.geeksforgeeks.org/drag-and-drop-files-in-electronjs/
    document.addEventListener('drop', (event) => {
        event.preventDefault();
        event.stopPropagation();
        for (const f of event.dataTransfer.files) {
            // Using the path attribute to get absolute file path and update main image
            L('File Path of dragged files: ', f.path)
            L(f.path)
            document.getElementById('before-image').src = "file://" + f.path;
            document.getElementById('after-image').src = "file://" + f.path;
            document.getElementById('before-image-card').href = "file://" + f.path;
            document.getElementById('after-image-card').href = "file://" + f.path;
        }
        updateImageFormat(document.getElementById('before-image'), 'before-image-format')
    });

    document.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    document.addEventListener('dragenter', (event) => {
        console.log('File is in the Drop Space');
    });

    document.addEventListener('dragleave', (event) => {
        console.log('File has left the Drop Space');
    });

    // Shortcut alternative to L used to toggle debugging logs
    const DEBUGGING = true;
    let L = (msg) => {
        if (DEBUGGING) console.log(msg);
    }

    // Launch modal into frame
    function showModal() {
        L('showing modal');
        document.getElementById('about-modal').classList.add('is-active'); // TODO - make modular and remove hard-code
    }

    // Remove modal from frame
    function removeModal() {
        L('closing modal');
        document.getElementById('about-modal').classList.remove('is-active');
    }

    // Fetch the image to rotate, and call image magick
    async function UpdateDisplay(inject_at, data) {
        let injection = document.getElementById(inject_at);
        injection.src = data; // Updates view with processed files
    }

    // Performs necessary operations to output altered photo
    async function Export() {
        L('Exporting')
        L("Quality: " + document.getElementById("quality-slider").value);
        L("Format: " + document.getElementById("format-dropdown").value);
        Quality();
    }

    // Compress image from path by strength -------------------------------------------------------------------
    //TODO - sanitize the input image path because it breaks if there are spaces. perhaps, const decodedPath = decodeURIComponent(f.path);
    async function Quality() {
        const inject_at = "after-image";
        const path = getImagePath();
        const quality = document.getElementById("quality-slider").value;
        let strength = 40

        // slider value is quality(100%) so we convert to strength(0%)
        if(quality != null) {
            strength = quality;
        }
        const fs = require('fs');
        let old_bytes = fs.readFileSync(path)
        console.log(old_bytes);
        let new_path = await reduceQuality(old_bytes, strength);
        let new_bytes = fs.readFileSync(new_path);
        L(new_bytes)
        var binaryData = [];
        binaryData.push(new_bytes);
        let data = window.URL.createObjectURL(new Blob(binaryData, {type: "application/zip"}))

        // Uses Sharp and updates view
        await UpdateDisplay(inject_at, data);
    }

    const fetch = require("node-fetch");
    const {v4: uuidv4} = require('uuid');
    // Returns full path of the image selected
    function getImagePath() {
        let main_input = document.getElementById('before-image');
        L(main_input)
        const filename = main_input.src.split('\\').pop().split('/').pop();
        const full_path = `${TEMP_OUT}/${filename}`;
        return full_path;
    }

    // Location used to output files to desktop regardless of Operating System
    const homeDir = require('os').homedir();
    const desktopDir = `${homeDir}/Desktop`;
    const TEMP_OUT = desktopDir;

    async function reduceQuality(obj, strength) {
        L('(Reducing Quality and Size...)');
        L(strength);

        const Sharp = require('../node_modules/sharp');
        const fs = require('fs');
        const random_uuid = uuidv4();

        let format = document.getElementById("format-dropdown").value;
        if (format == null) format = "webp";
        let new_path = `${desktopDir}/${random_uuid}.${format}`;

        // https://sharp.pixelplumbing.com/api-output#toformat
        let out_file = await Sharp(obj)
            .toFormat(format, {
                quality: parseInt(strength)
            })
            .toBuffer()
            .then(async data => {
                fs.writeFileSync(new_path, data);
                L(new_path)
                document.getElementById('after-image-card').href = new_path;
            })
            .catch(err => {
                L(err);
            });
        L(out_file);
        return new_path;
    }

    // EVENT LISTENERS AT START
    document.getElementById('about-modal-button').addEventListener('click', showModal);
    document.getElementById('close-modal').addEventListener('click', removeModal);
    document.getElementById('export-button').addEventListener('click', Export);
    document.addEventListener('DOMContentLoaded', function() {
        window.dispatchEvent(new Event('resize'));
    });

    // Function to update the file format and display it in the DOM
    function updateImageFormat(imageElement, formatElementId) {
        const imageSrc = imageElement.src;
        const format = imageSrc.substring(imageSrc.lastIndexOf(".") + 1).toUpperCase();
        document.getElementById(formatElementId).textContent = `Image Format: ${format}`;
    }

    // Function to update the selected format from the Options dropdown
    function updateSelectedFormat() {
        const selectedFormat = document.getElementById("format-dropdown").value;
        document.getElementById("after-image-format").textContent = `Selected Format: ${selectedFormat}`;
    }

    // Add an event listener to the format dropdown to update the selected format
    document.getElementById("format-dropdown").addEventListener("change", updateSelectedFormat);

    // Update image format initially
    updateImageFormat(document.getElementById("before-image"), "before-image-format");
    updateSelectedFormat(); // Initialize the selected format

    //Sharp test code
    let upload_area = document.getElementById('after-image');
    let file_uploaded;
</script>
</body>
</html>

