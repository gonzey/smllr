<!DOCTYPE html>
<!-- <div>Logo generated by <a href="https://www.designevo.com/" title="Free Online Logo Maker">DesignEvo free logo designer</a></div> -->
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width" name="viewport">
    <title>The Cool Compression App testdev</title>

    <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/12925c0993.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="remus.css">
    <script src="remus.js"></script>

    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kirang+Haerang&family=Lexend+Tera&display=swap" rel="stylesheet">

    <script src="holder.js"></script>
    <script src="bulma-toast.min.js"></script>
</head>

<style>
    html {
        font-family: 'Nunito Sans', sans-serif;
        /*background-color: rgb(37 37 37);*/
        zoom: 80%;
        /*background: rgb(2,0,36);*/
        /*background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(24,0,32,1) 100%);*/
        /*background: rgb(2,0,36);*/
        background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(19,0,25,1) 100%);
    }

    .float-left {
        float:left !important;
    }

    .float-right {
        float:right !important;
    }

    .stagger-left {
        position: relative;
        right:30px;
    }

    body {
        /*background-color: rgb(37 37 37);*/
        /*background: rgb(2,0,36);*/
        /*background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(35,0,46,1) 100%);*/
        /*background: rgb(2,0,36);*/
        /*background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(24,0,32,1) 100%);*/
        /*background: rgb(2,0,36);*/
        /*background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(19,0,25,1) 100%);*/
        background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(19,0,25,1) 100%)
    }

    button {
        margin: 10px;
    }

    #logo-img {
        width: 3vh;
        position: relative;
        top:0px
    }

    #app-name {
        text-align: center;
        position: relative;
        font-size: 3vh;
        font-family: 'Nunito Sans', sans-serif;
        /*font-family: 'Lexend Tera', sans-serif;*/
        /*font-family: 'Kirang Haerang', cursive;*/
    }

    #top-buttons {
        margin: 10px;
    }

    #about-modal-title {
        font-size: 3rem;
        font-family: 'Nunito Sans', sans-serif;
    }

    .tabs a:hover {
        background-color: rgba(0,0,0,0) !important;
    }

    .tabs li.is-active a {
        border-bottom-color: #32dc66;
        color: #7fff7d;
    }

    /* Ensure the size of the image fits the container perfectly */
    #image {
        max-width: 100%;  /* This rule is very important, please don't ignore this */
        display: block;
    }

    #upload-area {
        padding: 50%;
        cursor: pointer;
        /*width:100%;*/
        background-image: url(imgs/logo.png);
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center center;
    }

    #main-input {
        opacity: 0;
        position: absolute;
        z-index: -1;
    }

    .card {
        margin: 10px;
        color: white;
        background-color: #252525;
        /*background-color: #170404;*/
        /*background: rgb(12, 2, 186);*/
        /*background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgb(49, 33, 54) 100%);*/
        /*background: rgb(49, 33, 54, 0.8);*/
        /*border-radius: 30px;*/

    }

    .title {
        color: white;
    }

    input.vertical {
        -webkit-appearance: slider-vertical;
        writing-mode: bt-lr;
    }

    .has-background-purple {
        background-color: rgba(161, 19, 182, 0.2);
    }

    .has-silver-border {
        border: 1px solid silver;
        border-radius: 10px;
    }

    #about-modal {
        z-index: 999;
        /*background-color: darkgray;*/
    }

</style>

<body>
<div class="modal has-text-centered" id="about-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">About this application</p>
            <button aria-label="close" class="delete" id="close-modal"></button>
        </header>
        <section class="modal-card-body has-text-white has-background-black">
            <img src="imgs/logo.png"/>
            <div class='has-text-white app-name' id="about-modal-title">smaller</div>

            An image compressor created by David Bodey and Eric Gonzalez.
            <br/><br/>Powered by:<br/>
            Electron. NodeJS. Bulma. HTML. JS. CSS. Sharp. Remus.<br/> <br/>
        </section>
    </div>
</div>

<div class="container has-text-centered is-12">
    <!-- UI Buttons -->
    <div class="column is-12" id="top-buttons">
        <button class="button is-info is-outlined is-medium float-right" id="export-button">Export</button>
        <!-- <button class="button is-primary is-outlined is-medium float-right">Preview Changes</button>-->
        <!--                <button class="button is-warning is-5 is-outlined is-medium float-right" id="reset-button">Reset</button>-->
    </div>

    <div class="hero-foot">
        <nav class="tabs is-fullwidth">
            <div class="container">
                <ul>
                    <li>
                        <div id="app-name"> <img id="logo-img" src="imgs/logo.png">smaller</div>
                    </li>
                    <li class="is-active">
                        <a>Overview</a>
                    </li>
                    <li>
                        <a class="navbar-item has-text-white" id="about-modal-button">
                            About
                        </a>
                    </li>
                    <!--                            <li>-->
                    <!--                                <a class="navbar-item has-text-white">-->
                    <!--                                    Settings-->
                    <!--                                </a>-->
                    <!--                            </li>-->
                </ul>
            </div>
        </nav>
    </div>
    <br>

    <!-- User input buttons and sliders -->
    <div class="columns is-link" id="main-inputs">
        <div class=" column is-2">
            <div class="is-black has-text-primary-light is-size-4">Options</div>

            <div class="card-content">
                <!-- Export Format dropdown-->
                <div class="select">
                    <select id="format-dropdown">
                        <option value="none" selected disabled hidden>Format</option>
                        <option value="JPEG">JPEG</option>
                        <option value="PNG">PNG</option>
                        <option value="WEBP">WEBP</option>
<!--                        <option value="GIF">GIF</option>-->
<!--                        <option value="TIFF">TIFF</option>-->
<!--                        <option value="AVIF">AVIF</option>-->
<!--                        <option value="HEIF">HEIF</option>-->

                    </select>
                </div>

                <br><br><hr>

                <!-- Quality Range slider -->
                <label class="has-text-primary-light is-size-4" for="quality-slider">Quality</label><br><br>
                <input id="quality-slider" type="range" min="1" max="100" value="50" list="slider-steps">
                <datalist id="slider-steps">
                    <option>1</option>
                    <option>5</option>
                    <option>10</option>
                    <option>15</option>
                    <option>20</option>
                    <option>25</option>
                    <option>30</option>
                    <option>35</option>
                    <option>40</option>
                    <option>45</option>
                    <option>50</option>
                    <option>55</option>
                    <option>60</option>
                    <option>65</option>
                    <option>70</option>
                    <option>75</option>
                    <option>80</option>
                    <option>85</option>
                    <option>90</option>
                    <option>95</option>
                    <option>100</option>
                </datalist>
            </div>
        </div>

        <!-- Before/After Image cards -->
        <section class="hero column is-10">
            <div class="remus" id="main-imgs">
                <!-- Before -->
                <div class="card remus-element">
                    <a href="imgs/logo-full.svg" class="card-image" id="before-image-card" target="_blank">
                        <img id="before-image" src="imgs/logo-full.svg" />
                        <!--<p class="is-size-3 is-relative"><br>BEFORE</p>-->
                    </a>
                </div>
                <!-- After -->
                <div class="card remus-element">
                    <a href="imgs/drag-instructions.png" class="card-image" id="after-image-card" target="_blank">
                        <img class="" id="after-image" src="imgs/drag-instructions.png" />
                        <!--<br> <p class="is-size-3 is-relative"><br>AFTER</p>-->
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>

<script type="module">

    // Before/After slider
    var remus = new Remus({
        element: '.remus', // selector for main Remus container
        height: null // height value in pixels if you want it to be fixed - optional
    });

    // https://www.geeksforgeeks.org/drag-and-drop-files-in-electronjs/
    document.addEventListener('drop', (event) => {
        event.preventDefault();
        event.stopPropagation();
        for (const f of event.dataTransfer.files) {
            // Using the path attribute to get absolute file path and update main image
            L('File Path of dragged files: ', f.path)
            L(f.path)
            document.getElementById('before-image').src = "file://" + f.path;
            document.getElementById('after-image').src = "file://" + f.path;
            document.getElementById('before-image-card').href = "file://" + f.path;
            document.getElementById('after-image-card').href = "file://" + f.path;
        }
    });

    document.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    document.addEventListener('dragenter', (event) => {
        console.log('File is in the Drop Space');
    });

    document.addEventListener('dragleave', (event) => {
        console.log('File has left the Drop Space');
    });

    // Necessary variables/constants
    // const image = document.getElementById('image');
    var initial_image = true;
    let test_img = 'imgs/maxresdefault.jpg';

    // Shortcut alternative to L used to toggle debugging logs
    const DEBUGGING = true;
    let L = (msg) => {
        if (DEBUGGING) console.log(msg);
    }


    // Launch modal into frame
    function showModal() {
        L('showing modal');
        document.getElementById('about-modal').classList.add('is-active'); // TODO - make modular and remove hard-code
    }


    // Remove modal from frame
    function removeModal() {
        L('closing modal');
        document.getElementById('about-modal').classList.remove('is-active');
    }


    // Fetch the image to rotate, and call image magick
    async function UpdateDisplay(inject_at, data) {
        let injection = document.getElementById(inject_at);

        // Updates view with processed files
        // injection.src = URL.createObjectURL(img_bytes);
        injection.src = data;
    }


    // Converts image from path to bytes
    let getBytes = async function (path) {
        const image = await fetch(path);
        const array_buffer = await image.arrayBuffer();
        const image_bytes = new Uint8Array(array_buffer);

        return image_bytes;
    }


    // Performs necessary operations to output altered photo
    async function Export() {
        L('Exporting')
        L("Quality: " + document.getElementById("quality-slider").value);
        L("Format: " + document.getElementById("format-dropdown").value);
        Quality();
    }


    // Compress image from path by strength -------------------------------------------------------------------
    async function Quality() {
        const inject_at = "after-image";
        const path = getImagePath();
        const quality = document.getElementById("quality-slider").value;
        let strength = 40

        // slider value is quality(100%) so we convert to strength(0%)
        if(quality != null) {
            // strength = Math.abs(quality - 100);
            strength = quality;
        }
        // const img_bytes = await getBytes(path);

        const fs = require('fs');
        let old_bytes = fs.readFileSync(path)
        console.log(old_bytes);
        let new_path = await reduceQuality(old_bytes, strength);
        let new_bytes = fs.readFileSync(new_path);
        L(new_bytes)

        var binaryData = [];
        // binaryData.push(old_bytes);
        binaryData.push(new_bytes);

        let data = window.URL.createObjectURL(new Blob(binaryData, {type: "application/zip"}))

        // Uses Sharp and updates view
        await UpdateDisplay(inject_at, data);
    }


    // Update onscreen UI elements
    let setStageQuality = () => {
        // Setup stage
        clearStage();
        document.getElementById('quality-list-item').classList.add('is-active');

        // Create input Bar
        const input_bar = document.createElement('input');
        input_bar.type = "text";
        input_bar.id = "quality-input";
        input_bar.placeholder = "Enter desired compression (0-100%)";
        input_bar.className = "input is-primary is-medium is-rounded";
        input_bar.name = "quality-option";
        document.getElementById('main-title').appendChild(input_bar);

        // Create quality Button
        const quality_button = document.createElement('button');
        quality_button.className = "button is-primary is-rounded is-medium is-outlined";
        quality_button.id = "quality-button";
        quality_button.innerHTML = "Adjust Image Quality";
        quality_button.name = "quality-option";
        quality_button.addEventListener('click', Quality);
        document.getElementById('main-title').appendChild(quality_button);
    }


    let clearStage = () => {
        document.getElementById('main-title').innerHTML = "";
    }


    let resetImage = () => {
        if (initial_image == true) {
            document.getElementById("main-input").src = test_img;
        } else {
            L(file_uploaded);
            document.getElementById("main-input").src = file_uploaded;
        }
        // document.getElementById("main-input").src = test_img;
        // const path = document.getElementById("main-input").src;
        // const inject_at = "main-title";
        // const img_bytes = await getBytes(path);
        // const filename = path.split('\\').pop().split('/').pop();
    }


    const fetch = require("node-fetch");
    const {v4: uuidv4} = require('uuid');

    // https://chrisfrew.in/blog/saving-images-in-node-js-using-fetch-with-array-buffer-and-buffer/
    async function savePhotoFromURL(photo_url) {
        const response = await fetch(photo_url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        return buffer;
    }


    // Returns full path of the image selected
    function getImagePath() {
        let main_input = document.getElementById('before-image');
        L(main_input)
        const filename = main_input.src.split('\\').pop().split('/').pop();

        // const filename = main_input.value.split('\\').pop().split('/').pop();
        const full_path = `${TEMP_OUT}/${filename}`;
        return full_path;
    }


    const toBase64 = file => new Promise((resolve, reject) => { // (https://stackoverflow.com/questions/36280818/how-to-convert-file-to-base64-in-javascript)
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });


    // Location used to output files to desktop regardless of Operating System
    const homeDir = require('os').homedir();
    const desktopDir = `${homeDir}/Desktop`;
    const TEMP_OUT = desktopDir;

    async function reduceQuality(obj, strength) {
        L('(Reducing Quality and Size...)');
        L(strength);

        const Sharp = require('../node_modules/sharp');
        const fs = require('fs');
        const random_uuid = uuidv4();

        let format = document.getElementById("format-dropdown").value;
        if (format == null) format = "webp";
        let new_path = `${desktopDir}/${random_uuid}.${format}`;

        // let quality = Math.abs(strength - 100);
        // let photo_url = "https://picsum.photos/200/300"
        // let obj = await savePhotoFromURL(photo_url);
        // let obj = old_bytes

        // https://sharp.pixelplumbing.com/api-output#toformat
        let out_file = await Sharp(obj)
            .toFormat(format, {
                quality: parseInt(strength)
            })
            .toBuffer()
            .then(async data => {
                fs.writeFileSync(new_path, data);
                // document.getElementById("main-input").src = `${desktopDir}/${random_uuid}.${format}`;
                // let new_name =  URL.createObjectURL(new Blob([data.buffer]));
                // upload_area.style.backgroundImage = `url(${new_name})`;
                // L('newname:' + new_name.substr(4))
                L(new_path)
                document.getElementById('after-image-card').href = new_path;
            })
            .catch(err => {
                L(err);
            });
        L(out_file);
        return new_path;
    }

    // EVENT LISTENERS AT START
    // document.getElementById('quality-list-item').addEventListener('click', setStageQuality);
    document.getElementById('about-modal-button').addEventListener('click', showModal);
    document.getElementById('close-modal').addEventListener('click', removeModal);
    // document.getElementById('reset-button').addEventListener('click', resetImage);
    document.getElementById('export-button').addEventListener('click', Export);

    //Sharp test code
    let upload_area = document.getElementById('after-image');
    let file_uploaded;

    // document.getElementById('main-input').addEventListener('change', Quality);

</script>
</body>

</html>

